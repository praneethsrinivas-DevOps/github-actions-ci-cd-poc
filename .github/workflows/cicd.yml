name: Enterprise CI Pipeline

on:
  workflow_dispatch:
    inputs:
      branch:
        required: true
        type: string

jobs:

  prepare:
    runs-on: ubuntu-latest
    outputs:
      namespace: ${{ steps.set.outputs.namespace }}
    steps:
      - id: set
        run: |
          BRANCH="${{ github.event.inputs.branch }}"
          if [ "$BRANCH" = "qa" ]; then
            echo "namespace=nginx-qa" >> $GITHUB_OUTPUT
          elif [ "$BRANCH" = "production" ]; then
            echo "namespace=nginx-prod" >> $GITHUB_OUTPUT
          else
            echo "namespace=nginx-dev" >> $GITHUB_OUTPUT
          fi

  build_push:
    needs: prepare
    uses: praneethsrinivas-devops/github-actions-workflows/.github/workflows/build-push.yml@main
    with:
      image_name: devops-ci-cd-project
      registry: ghcr.io
      github_user: praneethsrinivas-devops
      branch: ${{ github.event.inputs.branch }}
    secrets:
      ghcr_token: ${{ secrets.GHCR_TOKEN }}

  ci_k8s_test:
    needs: [prepare, build_push]
    uses: praneethsrinivas-devops/github-actions-workflows/.github/workflows/ci-k8s.yml@main
    with:
      namespace: ${{ needs.prepare.outputs.namespace }}
      full_image: ${{ needs.build_push.outputs.full_image }}
    secrets:
      ghcr_token: ${{ secrets.GHCR_TOKEN }}
